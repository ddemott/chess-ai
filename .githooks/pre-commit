#!/usr/bin/env bash
set -euo pipefail

echo "Running pre-commit checks (lightweight)..."

# Run debug-print scan for staged files
ALL_STAGED_JAVA_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.java$' || true)
# Separate main and test staged Java files so we only scan main sources for debug prints
STAGED_JAVA_FILES=$(echo "$ALL_STAGED_JAVA_FILES" | grep '^src/main/java/.*\.java$' || true)
STAGED_TEST_JAVA_FILES=$(echo "$ALL_STAGED_JAVA_FILES" | grep '^src/test/java/.*\.java$' || true)
if [[ -n "$STAGED_JAVA_FILES" ]]; then
  # For speed, only scan the staged files
  BAD_PRINTS=()
  for f in $STAGED_JAVA_FILES; do
    # Ignore explicit console package debug prints
    if [[ "$f" == src/main/java/com/ddemott/chessai/console/* ]]; then
      continue
    fi
    if grep -nH "System\.out\.println\|System\.err\.println\|printStackTrace(" "$f" >/dev/null 2>&1; then
      BAD_PRINTS+=("$f")
    fi
  done
  if [[ ${#BAD_PRINTS[@]} -ne 0 ]]; then
    echo "Debug prints or stack traces found in staged files (excluding console package):"
    for file in "${BAD_PRINTS[@]}"; do
      echo "  - $file"
      grep -nH "System\.out\.println\|System\.err\.println\|printStackTrace(" "$file" || true
    done
    echo "\nPlease remove debug prints or wrap in logger statements before committing."
    exit 1
  fi
fi

# Optional quick smoke tests for staged Java test files - run a subset of tests if tests were changed
if [[ -n "$STAGED_TEST_JAVA_FILES" ]]; then
  echo "Detected staged test files. Running a quick smoke test set..."
  SMOKE_TESTS="com.ddemott.chessai.BoardCoreRulesTest,com.ddemott.chessai.BoardFENTest,com.ddemott.chessai.PawnMovementTest"
  if ! mvn -q -Dtest="$SMOKE_TESTS" test; then
    echo "Quick smoke tests failed. Please run full tests and fix failures before committing."
    exit 1
  fi
fi

echo "Pre-commit checks passed."
exit 0
